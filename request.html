<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Mar 16, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Async Http Client - Executing request</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
        <style>body{padding-top: 60px;}</style>
    
      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

    
      <meta name="author" content="Jeanfrancois Arcand" />
    <meta name="Date-Revision-yyyymmdd" content="20120316" />
    <meta http-equiv="Content-Language" content="en" />
    
        </head>
  <body>
      
                        
                    
        <div id="topbar" class="topbar" data-dropdown="dropdown">
      <div class="topbar-inner">
                <div class="container">
                
          <ul>
                        <li class="dropdown" data-dropdown="dropdown" >
        <a href="#" class="dropdown-toggle">User guide</a>
        <ul class="dropdown-menu">
                      <li>      <a href="request.html"  title="Executing request">Executing request</a>
</li>
                      <li>      <a href="configuring.html"  title="Configuring the AsyncHttpClient">Configuring the AsyncHttpClient</a>
</li>
                      <li>      <a href="ssl.html"  title="SSL">SSL</a>
</li>
                      <li>      <a href="filters.html"  title="Using Filters">Using Filters</a>
</li>
                      <li>      <a href="upload.html"  title="Uploading file">Uploading file</a>
</li>
                      <li>      <a href="auth.html"  title="Authentication">Authentication</a>
</li>
                      <li>      <a href="proxy.html"  title="Proxy">Proxy</a>
</li>
                      <li>      <a href="providers.html"  title="Switching Provider">Switching Provider</a>
</li>
                      <li>      <a href="webdav.html"  title="Using the WebDav protocol">Using the WebDav protocol</a>
</li>
                      <li>      <a href="resumable-download.html"  title="Resumable Dowload">Resumable Dowload</a>
</li>
                      <li>      <a href="transfer-listener.html"  title="TransferListener">TransferListener</a>
</li>
                      <li>      <a href="zero-bytes-copy.html"  title="Zero Bytes Copy">Zero Bytes Copy</a>
</li>
                      <li>      <a href="performances.html"  title="Improve raw performance">Improve raw performance</a>
</li>
                      <li>      <a href="oauth.html"  title="OAuth">OAuth</a>
</li>
                  </ul>
      </li>
                <li class="dropdown" data-dropdown="dropdown" >
        <a href="#" class="dropdown-toggle">Project Documentation</a>
        <ul class="dropdown-menu">
                      <li>      <a href="project-info.html"  title="Project Information">Project Information</a>
</li>
                      <li>      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
</li>
                  </ul>
      </li>
                </ul>
          
                        
        
        
        <ul class="nav secondary-nav"><li>
    
    <a href="https://twitter.com/jfarcand" class="twitter-follow-button" data-show-count="true" data-align="right" data-size="large" data-show-screen-name="true" data-lang="en">Follow jfarcand</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

        </li></ul>
                
                  </div>
      </div>
    </div>
    
        <div class="container">
          
      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 16 March 2012</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 1.8.0-SNAPSHOT</li>
                      
                
                    
      
                  </ul>
      </div>

      
      <div id="bodyColumn" class="content">
        <div id="contentBox">
                              
          <div class="section"><h2>Executing request synchronously or asynchronously.<a name="Executing_request_synchronously_or_asynchronously."></a></h2><p>The first thing to decide when using the library is if your application can handle asynchronous response or not. If not, the library has been designed using the Future API, hence you can always execute synchronous call by blocking on the <tt>Future.get()</tt> method:</p><div class="source"><pre class="prettyprint">AsyncHttpClient client = new AsyncHttpClient();
Response response = client.prepareGet((&quot;http://sonatype.com&quot;).execute().get();</pre></div><p>The above means the request will block until the full Response has been received. It also made your application's blocking, waiting for the response to comes back. This could be potentially an issue to block for every request, specially when doing <tt>POST</tt> or <tt>PUT</tt> operations where you don't necessarily need to wait for the response. A simple way consist of not calling the <tt>Future.get()</tt></p><div class="source"><pre class="prettyprint">AsyncHttpClient client = new AsyncHttpClient();
Response response = client.preparePut((&quot;http://sonatype.com/myFile.avi&quot;).execute();</pre></div><p>A better way than above would consist of using an AsyncHandler. The AynchHandler API is fairly simple and just consists of 5 methods to implements:</p><div class="source"><pre class="prettyprint">public interface AsyncHandler&lt;T&gt; {
    void onThrowable(Throwable t);

    STATE onBodyPartReceived(HttpResponseBodyPart bodyPart)
        throws Exception;

    STATE onStatusReceived(HttpResponseStatus responseStatus)
        throws Exception;

    STATE onHeadersReceived(HttpResponseHeaders headers)
        throws Exception;

    T onCompleted() throws Exception;
}</pre></div><div class="section"><h3>Creating a Request object<a name="Creating_a_Request_object"></a></h3><p>The AsynHttpClient uses the builder pattern when it is time to create Request object. The simplest way consist of:</p><div class="source"><pre class="prettyprint">RequestBuilder builder = new RequestBuilder(&quot;PUT&quot;);
Request request = builder..setUrl(&quot;http://&quot;)
    .addHeader(&quot;name&quot;, &quot;value&quot;)
    .setBody(new File(&quot;myUpload.avi&quot;))
    .build();
AsyncHttpClient client = new AsyncHttpClient();
client.execute(request, new AsyncHandler&lt;...&gt;() {
.....
} );</pre></div><p>If you need to work with File, the library supports the <a href="./zero-bytes-copy.html">zero copy in memory concept</a>, e.g the File can be uploaded or downloaded without loading its associated bytes in memory, preventing out of memory errors in case you need to upload or download many large files. Although the library support the following:</p><div class="source"><pre class="prettyprint">Request request = builder.setUrl(&quot;http://&quot;)
    .addHeader(&quot;name&quot;, &quot;value&quot;)
    .setBody(myInputStream))
    .build();</pre></div><p>it is discouraged to use <tt>InputStream</tt> as the library will need to buffer bytes in memory in order to determine the length of the stream, and instead highly recommended to either use a File or the <tt>BodyGenerator</tt> API to avoid loading unnecessary bytes in memory:</p><div class="source"><pre class="prettyprint">public interface BodyGenerator {
    Body createBody() throws IOException;
}</pre></div><p>where a Body is defined as:</p><div class="source"><pre class="prettyprint">public interface Body {
    long getContentLength();

    long read(ByteBuffer buffer)
        throws IOException;

    void close() throws IOException;
}</pre></div><p>This way the library will never read unnecessary bytes in memory, which could significantly improve the performance your application.</p><p>The <tt>RequestBuilder</tt> can also be used to create per <tt>Request</tt> configuration, like setting a Proxy or request timeout:</p><div class="source"><pre class="prettyprint">PerRequestConfig requestConfig = new PerRequestConfig();
requestConfig.setRequestTimeoutInMs(5 * 1000);
requestConfig.setProxy(new ProxyServer(...));
Future responseFuture = client.prepareGet(&quot;http://&quot;).setPerRequestConfig(requestConfig).execute();</pre></div></div><div class="section"><h3>Creating a Response object<a name="Creating_a_Response_object"></a></h3><p>The AsyncHandler is typed, e.g you can return any object from the <tt>AsyncHandler.onCompleted()</tt>. One useful object of the library is the <tt>Response</tt> object and it's associate builder. You can incrementally create a <tt>Response</tt> object using the <tt>ResponseBuilder.accumulate()</tt> method:</p><div class="source"><pre class="prettyprint">MyAsyncHandler&lt;Response&gt; asyncHandler = new MyAsyncHanfler&lt;Response&gt;() {
    private final Response.ResponseBuilder builder = new Response.ResponseBuilder();

    public STATE onBodyPartReceived(final HttpResponseBodyPart content) throws Exception {
        builder.accumulate(content);
        return STATE.CONTINUE;
    }

    public STATE onStatusReceived(final HttpResponseStatus status) throws Exception {
        builder.accumulate(status);
        return STATE.CONTINUE;
    }

    public STATE onHeadersReceived(final HttpResponseHeaders headers) throws Exception {
        builder.accumulate(headers);
        return STATE.CONTINUE;
    }

    public Response onCompleted() throws Exception {
        return builder.build();
    }

}

Response response = client.prepareGet(&quot;http://sonatype.com&quot;).execute(asyncHandler).get();</pre></div><p>One thing to consider when creating a <tt>Response</tt> object is the size of the response body. By default, a <tt>Response</tt> object will accumulate all response's bytes in memory, and that could potentially create an out of memory error. If you are planning to use the API for downloading large files, it is not recommended to accumulate bytes in memory and instead flush the bytes on disk as soon as they are available. Note that you can still use the <tt>Response</tt> object, except you don't accumulate the response's bytes as demonstrated below:</p><div class="source"><pre class="prettyprint">MyAsyncHandler&lt;Response&gt; asyncHandler = new MyAsyncHanfler&lt;Response&gt;() {
    private final Response.ResponseBuilder builder = new Response.ResponseBuilder();

    public STATE onBodyPartReceived(final HttpResponseBodyPart content) throws Exception {
        content.write(myOutputStream);
        return STATE.CONTINUE;
    }

    public STATE onStatusReceived(final HttpResponseStatus status) throws Exception {
        builder.accumulate(status); return STATE.CONTINUE;
    }

    public STATE onHeadersReceived(final HttpResponseHeaders headers) throws Exception {
        builder.accumulate(headers);
        return STATE.CONTINUE;
    }

    public Response onCompleted() throws Exception {
        return builder.build();
    }

}

Response response = client.prepareGet(&quot;http://sonatype.com&quot;).execute(asyncHandler).get();</pre></div><p>Note that in the above scenario invoking <tt>Response.getResponseBodyAsStream()</tt> or <tt>getResponseBody()</tt> will return an <tt>IllegalStateException</tt> because the body wasn't accumulated by the <tt>Response</tt> object.</p></div></div>
                  </div>
      </div>
    </div>

    <footer class="footer">
            <div class="container">
              <div class="row span16">Copyright &copy;                   2012.
          All Rights Reserved.      
                    
      </div>

        
                <p id="poweredBy" class="pull-right">
                          <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
              </p>
        
                </div>
    </footer>
  </body>
</html>
